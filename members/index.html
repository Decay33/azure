<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Members Hub - The AI Democracy</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="scanline"></div>
  <div class="circuit-lines">
    <div class="circuit-line horizontal-line" style="top: 15%; left: 5%; width: 150px;"></div>
    <div class="circuit-line vertical-line" style="top: 30%; left: 10%; height: 120px;"></div>
    <div class="circuit-dot" style="top: 30%; left: 10%;"></div>
    <div class="circuit-line horizontal-line" style="top: 75%; right: 5%; width: 200px;"></div>
    <div class="circuit-line vertical-line" style="top: 60%; right: 20%; height: 150px;"></div>
    <div class="circuit-dot" style="top: 60%; right: 20%;"></div>
    <div class="circuit-line horizontal-line" style="top: 40%; right: 30%; width: 100px;"></div>
    <div class="circuit-dot" style="top: 40%; right: 30%;"></div>
  </div>

  <nav class="nav-bar">
    <a href="/" class="nav-logo"><span class="nav-logo-the">THE</span>AI<span>Democracy</span></a>
    <div class="nav-links">
      <a href="/" class="nav-link">Home</a>
      <a href="/#game-list" class="nav-link">Games</a>
      <a href="/tools/" class="nav-link">Tools</a>
      <a href="/#contact" class="nav-link">Contact</a>
      <a href="/privacy.html" class="nav-link">Privacy</a>
    </div>
    <div class="nav-links nav-auth">
      <a id="sign-out-link" class="nav-link" href="/.auth/logout?post_logout_redirect_uri=/">Sign Out</a>
    </div>
  </nav>

  <div class="auth-banner" id="auth-banner">
    <span id="auth-status">Loading your profile...</span>
  </div>

  <main class="members-main">
    <header>
      <h1>Members Command Center</h1>
      <p class="ai-statement">This area gives you early looks at upcoming AI experiments, community drops, and progress snapshots tailored to members.</p>
    </header>

    <section class="members-card">
      <h2>Your Identity</h2>
      <dl class="member-meta">
        <div>
          <dt>Name</dt>
          <dd id="member-name">?</dd>
        </div>
        <div>
          <dt>Email</dt>
          <dd id="member-email">?</dd>
        </div>
        <div>
          <dt>Provider</dt>
          <dd id="member-provider">?</dd>
        </div>
        <div>
          <dt>Roles</dt>
          <dd id="member-roles">?</dd>
        </div>
      </dl>
    </section>

    <section class="members-card">
      <h2>Next Steps</h2>
      <ul class="members-actions">
        <li>Test drive upcoming game builds before they hit the public hub.</li>
        <li>Track engagement stats powered by your secure EasyAuth identity.</li>
        <li>Use the contact form on the home page to pitch tools or games - we prioritize member submissions.</li>
      </ul>
    </section>

    <section class="members-card members-score-section" id="members-highscores">
      <div class="members-card-header">
        <h2>Game High Scores</h2>
        <p class="muted">
          Track your personal records and tap a title to explore the live leaderboard. Scores sync automatically once
          you finish a run while signed in.
        </p>
      </div>

      <div class="members-score-columns">
        <article class="members-score-panel" aria-labelledby="personal-highscores-title">
          <header class="members-score-panel-header">
            <h3 id="personal-highscores-title">Your Records</h3>
            <p id="personal-score-status" class="members-score-status" aria-live="polite">Loading your scores...</p>
          </header>
          <ol id="personal-score-list" class="member-score-list" aria-live="polite"></ol>
        </article>

        <article class="members-score-panel" aria-labelledby="members-leaderboard-title">
          <header class="members-score-panel-header">
            <h3 id="members-leaderboard-title">Leaderboard</h3>
            <p id="members-leaderboard-desc" class="members-score-hint">
              Select a game to explore its global leaderboard.
            </p>
          </header>
          <p id="members-leaderboard-status" class="members-score-status" aria-live="polite">No game selected.</p>
          <ol id="members-leaderboard-list" class="member-score-list" aria-live="polite"></ol>
        </article>
      </div>
    </section>
  </main>

  <footer>
    <p>Powered by Advanced AI Technology - Your member data stays protected behind Azure Static Web Apps EasyAuth.</p>
    <div class="footer-links">
      <a href="/privacy.html" class="footer-link">Privacy Policy</a>
      <a href="/#contact" class="footer-link">Contact Us</a>
      <a href="/.auth/logout?post_logout_redirect_uri=/" class="footer-link">Sign Out</a>
    </div>
  </footer>

  <script>
    const GAME_CONFIG = {
      chromaticrunner: { name: "Chromatic Runner", path: "/chromaticrunner/" },
      cavegrok: { name: "Cave Grok", path: "/cavegrok/" },
      diceflip: { name: "DiceFlip", path: "/diceflip/" }
    };
    async function getMe() {
      try {
        const response = await fetch('/.auth/me', { credentials: 'include' });
        if (!response.ok) {
          return null;
        }
        const payload = await response.json();
        return payload && payload.clientPrincipal || null;
      } catch (_error) {
        return null;
      }
    }

    function normalizeIdentifier(value) {
      if (!value) {
        return null;
      }
      return value.toString().trim().toLowerCase().replace(/[^a-z0-9_-]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    }

    function normalizePrincipalId(principal) {
      if (!principal) {
        return null;
      }
      const candidates = [principal.userId, principal.userDetails];
      for (const candidate of candidates) {
        const normalized = normalizeIdentifier(candidate);
        if (normalized) {
          return normalized;
        }
      }
      return null;
    }

    function friendlyGame(slug) {
      return GAME_CONFIG[slug] || { name: slug, path: null };
    }

    function sanitizeNameValue(raw) {
      if (!raw && raw !== 0) {
        return null;
      }
      let value = String(raw).trim();
      if (!value) {
        return null;
      }
      const atIndex = value.indexOf('@');
      if (atIndex > 0) {
        value = value.slice(0, atIndex);
      }
      value = value.split(/\s+/)[0];
      value = value.replace(/[^A-Za-z0-9_-]/g, '');
      if (!value) {
        return null;
      }
      return value.charAt(0).toUpperCase() + value.slice(1);
    }

    function deriveFirstName(...candidates) {
      for (const candidate of candidates) {
        const sanitized = sanitizeNameValue(candidate);
        if (sanitized) {
          return sanitized;
        }
      }
      return 'Player';
    }

    function getClaim(principal, ...types) {
      if (!principal?.claims) {
        return null;
      }
      const wanted = types.map((type) => String(type).toLowerCase());
      for (const claim of principal.claims) {
        const claimType = String(claim?.typ || '').toLowerCase();
        if (wanted.includes(claimType)) {
          return claim.val;
        }
      }
      return null;
    }

    function firstNameFromPrincipal(principal) {
      if (!principal) {
        return 'Player';
      }
      const nameClaim = getClaim(
        principal,
        'name',
        'http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'
      );
      return deriveFirstName(nameClaim, principal.userDetails, principal.userId);
    }

    function emailFromPrincipal(principal) {
      if (!principal) {
        return null;
      }
      return (
        getClaim(principal, 'emails', 'email', 'preferred_username') ||
        principal.userDetails ||
        null
      );
    }

    function playerNameFromEntry(entry) {
      if (!entry) {
        return 'Player';
      }
      return deriveFirstName(entry.displayName, entry.userId);
    }

    let normalizedUserId = null;
    let currentLeaderboardSlug = null;
    let cachedPrincipal = null;

    function setActivePersonalRow(slug) {
      const list = document.getElementById('personal-score-list');
      if (!list) {
        return;
      }
      Array.from(list.children).forEach((item) => {
        if (item.dataset.slug === slug) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    async function loadLeaderboardForGame(slug) {
      const titleEl = document.getElementById('members-leaderboard-title');
      const descEl = document.getElementById('members-leaderboard-desc');
      const statusEl = document.getElementById('members-leaderboard-status');
      const listEl = document.getElementById('members-leaderboard-list');
      if (!statusEl || !listEl) {
        return;
      }

      currentLeaderboardSlug = slug;
      setActivePersonalRow(slug);

      const game = friendlyGame(slug);
      if (titleEl) {
        titleEl.textContent = `${game.name} Leaderboard`;
      }
      if (descEl) {
        if (game.path) {
          descEl.innerHTML = `Play <a href="${game.path}">${game.name}</a> to climb the rankings.`;
        } else {
          descEl.textContent = 'Select a game to explore its global leaderboard.';
        }
      }

      statusEl.textContent = 'Loading leaderboard...';
      listEl.innerHTML = '';

      try {
        const response = await fetch(`/api/scores?gameId=${encodeURIComponent(slug)}&limit=25`, {
          credentials: 'include'
        });
        if (!response.ok) {
          throw new Error('Failed to load leaderboard');
        }
        const data = await response.json();
        const entries = Array.isArray(data.entries) ? data.entries : [];

        if (!entries.length) {
          statusEl.textContent = 'No scores recorded yet. Be the first to set a record!';
          return;
        }

        statusEl.textContent = '';
        entries.forEach((entry, index) => {
          const li = document.createElement('li');
          li.className = 'member-score-row';

          const rank = document.createElement('span');
          rank.className = 'rank';
          rank.textContent = index + 1;

          const name = document.createElement('span');
          name.className = 'player';
          name.textContent = playerNameFromEntry(entry);

          const score = document.createElement('span');
          score.className = 'score';
          score.textContent = Number(entry.bestScore || entry.score || 0).toLocaleString();

          li.append(rank, name, score);

          if (entry.updatedAt) {
            const meta = document.createElement('small');
            const date = new Date(entry.updatedAt);
            meta.textContent = 'Updated ' + date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            li.appendChild(meta);
          }

          if (normalizedUserId && entry.userId === normalizedUserId) {
            li.classList.add('member-score-me');
          }

          listEl.appendChild(li);
        });
      } catch (error) {
        console.warn('Failed to load leaderboard', error);
        statusEl.textContent = 'Leaderboard unavailable right now.';
      }
    }

    async function loadPersonalScores() {
      const status = document.getElementById('personal-score-status');
      const list = document.getElementById('personal-score-list');
      if (!status || !list) {
        return;
      }

      list.innerHTML = '';
      status.textContent = 'Loading...';

      try {
        const response = await fetch('/api/scores?personal=true', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Failed to load personal scores');
        }

        const data = await response.json();
        const scores = Array.isArray(data.personal) ? data.personal : [];

        if (!scores.length) {
          status.textContent = 'No scores yet. Play a game to set your first record.';
          const leaderboardStatus = document.getElementById('members-leaderboard-status');
          if (leaderboardStatus) {
            leaderboardStatus.textContent = 'No game selected.';
          }
          const leaderboardList = document.getElementById('members-leaderboard-list');
          if (leaderboardList) {
            leaderboardList.innerHTML = '';
          }
          return;
        }

        status.textContent = '';
        list.innerHTML = '';

        scores.forEach((entry) => {
          const config = friendlyGame(entry.slug);
          const li = document.createElement('li');
          li.className = 'member-score-row selectable';
          li.dataset.slug = entry.slug;
          li.tabIndex = 0;

          const icon = document.createElement('span');
          icon.className = 'rank';
          icon.textContent = '\u25B6';

          const name = document.createElement('span');
          name.className = 'player';
          name.textContent = config.name;

          const score = document.createElement('span');
          score.className = 'score';
          score.textContent = Number(entry.bestScore || 0).toLocaleString();

          li.append(icon, name, score);

          if (entry.updatedAt) {
            const meta = document.createElement('small');
            const date = new Date(entry.updatedAt);
            meta.textContent = 'Updated ' + date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            li.appendChild(meta);
          }

          li.addEventListener('click', () => loadLeaderboardForGame(entry.slug));
          li.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              loadLeaderboardForGame(entry.slug);
            }
          });

          list.appendChild(li);
        });

        const defaultSlug = scores.find((entry) => entry.slug === currentLeaderboardSlug)?.slug || scores[0].slug;
        loadLeaderboardForGame(defaultSlug);
      } catch (error) {
        console.warn('Failed to load personal scores', error);
        status.textContent = 'Unable to load your scores right now.';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      cachedPrincipal = await getMe();

      const authStatus = document.getElementById('auth-status');
      const nameEl = document.getElementById('member-name');
      const emailEl = document.getElementById('member-email');
      const providerEl = document.getElementById('member-provider');
      const rolesEl = document.getElementById('member-roles');

      if (!cachedPrincipal) {
        if (authStatus) {
          authStatus.textContent = 'Your session expired. Please sign in again.';
        }
        if (nameEl) {
          nameEl.textContent = '-';
        }
        if (emailEl) {
          emailEl.textContent = '-';
        }
        if (providerEl) {
          providerEl.textContent = '-';
        }
        if (rolesEl) {
          rolesEl.textContent = '-';
        }
        const personalStatus = document.getElementById('personal-score-status');
        if (personalStatus) {
          personalStatus.textContent = 'Sign in to view your high scores.';
        }
        const leaderboardStatus = document.getElementById('members-leaderboard-status');
        if (leaderboardStatus) {
          leaderboardStatus.textContent = 'Sign in to load leaderboards.';
        }
        return;
      }

      const firstName = firstNameFromPrincipal(cachedPrincipal);
      const emailAddress = emailFromPrincipal(cachedPrincipal);

      if (authStatus) {
        authStatus.innerHTML = `Welcome back, <strong>${firstName}</strong>.`;
      }
      if (nameEl) {
        nameEl.textContent = firstName;
      }
      if (emailEl) {
        emailEl.textContent = emailAddress || '-';
      }
      if (providerEl) {
        providerEl.textContent = cachedPrincipal.identityProvider || 'Google';
      }
      if (rolesEl) {
        rolesEl.textContent = (cachedPrincipal.userRoles || []).join(', ');
      }

      normalizedUserId = normalizePrincipalId(cachedPrincipal);
      await loadPersonalScores();
    });

    window.addEventListener('focus', async () => {
      if (!cachedPrincipal) {
        return;
      }

      const refreshed = await getMe();
      if (!refreshed) {
        cachedPrincipal = null;
        normalizedUserId = null;
        const personalStatus = document.getElementById('personal-score-status');
        if (personalStatus) {
          personalStatus.textContent = 'Sign in to view your high scores.';
        }
        const list = document.getElementById('personal-score-list');
        if (list) {
          list.innerHTML = '';
        }
        const leaderboardStatus = document.getElementById('members-leaderboard-status');
        if (leaderboardStatus) {
          leaderboardStatus.textContent = 'Sign in to load leaderboards.';
        }
        const leaderboardList = document.getElementById('members-leaderboard-list');
        if (leaderboardList) {
          leaderboardList.innerHTML = '';
        }
        return;
      }

      cachedPrincipal = refreshed;
      normalizedUserId = normalizePrincipalId(refreshed);
      await loadPersonalScores();
    });
  </script>
</body>
</html>












